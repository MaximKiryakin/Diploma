\documentclass[]{article}

\usepackage[utf8]{inputenc}
\usepackage[russian]{babel}
\usepackage[left=1.5cm,right=1.5cm,top=2cm,bottom=2.5cm]{geometry}

\usepackage[fontsize=13pt]{scrextend}

% что-то за межстрочный интервал отвечающее
\renewcommand{\baselinestretch}{1.3}

\usepackage{comment}

\usepackage[nooneline]{caption}
\usepackage{subcaption}
\usepackage{indentfirst}
\usepackage{tabularx}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{multirow}
\usepackage{hyperref}

\usepackage{booktabs, array} % для таблиц
%\usepackage[utf8]{inputenc}
%\usepackage[T2A]{fontenc}
%\usepackage[russian]{babel}

\usepackage{fancyhdr}


\setlength{\headheight}{15mm}


\usepackage[pdftex]{graphicx}
\graphicspath{{img/}}

%\pagestyle{fancy}
%\lhead{\textbf{\normalsize Проект 2}}
%\rhead{\textbf{\normalsize Выполнили: }\normalsize Кирякин %Максим, Куренкова Дарья, Коваль Наталия}



\usepackage{listings}
\usepackage{xcolor}

\definecolor{darkback}{rgb}{0.1, 0.1, 0.1}
\definecolor{termgreen}{rgb}{0.4, 0.6, 0.4}
\definecolor{termdarkgreen}{rgb}{0.3, 0.5, 0.3}
\definecolor{termcyan}{rgb}{0.3, 0.7, 0.9}
\definecolor{termblue}{rgb}{0.3, 0.6, 1.0}
\definecolor{termyellow}{rgb}{0.9, 0.8, 0.3}
\definecolor{termorange}{rgb}{0.9, 0.5, 0.3}
\definecolor{termwhite}{rgb}{0.95, 0.95, 0.95}
\definecolor{lightgray}{rgb}{0.97, 0.97, 0.97}

\lstdefinestyle{terminal}{
	language=Python,
	backgroundcolor=\color{darkback},
	commentstyle=\color{termgreen},
	stringstyle=\color{termgreen},
	basicstyle=\ttfamily\scriptsize\color{termwhite},
	identifierstyle=\color{termwhite},
	breakatwhitespace=false,
	breaklines=true,
	captionpos=b,
	keepspaces=true,
	numbers=none,
	tabsize=2,
	frame=l,
	xleftmargin=5pt,
	framexleftmargin=0pt,
	resetmargins=true,
	rulecolor=\color{gray},
	framerule=0.5pt,
	showstringspaces=false,
	% Group 1: Classes (Dark Green, Bold)
	keywordstyle=[1]\bfseries\color{termdarkgreen},
	morekeywords=[1]{Portfolio},
	% Group 2: Methods (Yellow)
	keywordstyle=[2]\color{termyellow},
	morekeywords=[2]{log_system_info, load_stock_data, load_multipliers, load_macro_data, add_dynamic_features, create_portfolio, add_merton_pd, predict_dd, optimize_portfolio, calc_portfolio_metrics},
	% Group 3: Variables and Parameters (Cyan)
	keywordstyle=[3]\color{termcyan},
	morekeywords=[3]{portfolio, tickers, dt_calc, dt_start, stocks_step, tickers_list, update_backup, lambda_risk, horizon, model_type},
	% Group 4: Booleans (Blue)
	keywordstyle=[4]\color{termblue},
	morekeywords=[4]{True, False, None},
}

\lstdefinestyle{treestyle}{
	backgroundcolor=\color{gray!5},
	basicstyle=\ttfamily\footnotesize,
	commentstyle=\itshape\color{termgreen},
	keepspaces=true,
	numbers=none,
	showspaces=false,
	showstringspaces=false,
	showtabs=false,
	tabsize=2,
	frame=none,
	xleftmargin=0pt,
	resetmargins=true,
	literate={|--}{{\textcolor{termblue}{|--}}}3
	         {+--}{{\textcolor{termblue}{+--}}}3
	         {|}{{\textcolor{termblue}{|}}}1,
}

\lstset{style=treestyle}

\begin{document}

	\input{title.tex}

	\newpage
	\tableofcontents

	\newpage
	\section*{Введение}
	\addcontentsline{toc}{section}{Введение}


	Современный этап развития финансовых систем характеризуется возрастающей сложностью управления кредитными рисками
	на фоне динамичных макроэкономических изменений. Ускоренное внедрение технологий больших данных и машинного обучения,
	а также усиление глобальной экономической нестабильности, обусловленной санкционными ограничениями, пандемией и
	геополитическими кризисами, стимулируют трансформации подходов к управлению кредитными портфелями. В условиях
	турбулентности кредитные организации сталкиваются с необходимостью адаптации риск-менеджмента, включая модернизацию
	методов стресс-тестирования и разработку моделей, способных учитывать волатильность ключевых макроэкономических
	индикаторов. Данные факторы оказывают непосредственное влияние на вероятность дефолта заемщиков, что угрожает
	устойчивости финансовых институтов и требует разработки новых подходов к управлению кредитными портфелями.

	Объектом настоящего исследования выступают кредитные портфели российских коммерческих банков, функционирующие в
	условиях высокой волатильности макроэкономической среды, включая колебания индекса РТС, ключевой ставки ЦБ РФ,
	курса рубля и динамики ВВП. Предмет исследования охватывает методы управления кредитными рисками, в частности,
	оценку кредитоспособности заемщиков, диверсификацию портфеля и прогнозирование вероятности дефолта (PD) с
	использованием количественных моделей, таких как модель Мертона. Последняя основанна на структурном подходе и
	формализует вероятность дефолта через соотношение стоимости активов компании \( V \), уровня долга \( D \) и
	волатильности доходности активов \( \sigma_V \):

	$$
	PD = \Phi \left( \frac{\ln \left( \frac{V}{D} \right)
	 + \left( r - \frac{\sigma_V^2}{2} \right) T}{\sigma_V \sqrt{T}} \right),
	$$

	где \( \Phi \) — функция распределения стандартной нормальной случайной величины,
	 \( r \) — безрисковая ставка, \( T \) — временной горизонт.

Целью настоящего исследования является разработка и программная реализация гибридного алгоритма управления
	кредитным портфелем, позволяющего минимизировать риски в условиях макроэкономической нестабильности. Методология
	исследования базируется на подходе, объединяющем структурные модели кредитного риска и макроэкономическое
	прогнозирование, что соответствует математической постановке задачи стохастической оптимизации. Исследование
	осуществляется в четыре этапа. На первом этапе проводится эконометрический анализ чувствительности параметров
	модели Мертона — в частности, дистанции до дефолта $DD_i$ и вероятности дефолта $PD_i$ — к изменениям
	макроэкономических факторов, формализуемых вектором $M_t$ (инфляция, ключевая ставка, безработица, курс рубля).
	Второй этап предполагает прогнозирование динамики макропоказателей $M_{forecast}$ на основе моделей временных рядов
	(\textbf{VAR}, \textbf{SARIMAX}, \textbf{Facebook Prophet}). На третьем этапе полученные макроэкономические сценарии
	через установленные регрессионные зависимости трансформируются в прогнозы вероятностей дефолта
	$PD_i(M_{forecast})$. Заключительный этап посвящен оптимизации структуры портфеля: определению вектора весов $w^*$,
	минимизирующего функцию риска, объединяющую ожидаемые кредитные потери ($EL$) и рыночную волатильность портфеля.

	Эмпирическая база исследования сформирована на данных системообразующих российских компаний различных секторов
	экономики. Для каждого эмитента $i$ восстановлены динамические параметры модели Мертона. Моделирование взаимосвязи
	между микроэкономическими параметрами заемщиков и макросредой $M_t$ выполнено с использованием метода наименьших
	квадратов (OLS), что позволило идентифицировать спецификации вида $PD_{i,t} = \beta_{i,0} + \beta_i^T M_t +
	\varepsilon_{i,t}$, связывающие макроэкономическую динамику с кредитным качеством заемщиков.

	Научная новизна работы заключается в интеграции структурного подхода Мертона, гибридных методов прогнозирования
	макропоказателей и методов портфельной оптимизации в единый алгоритмический комплекс. В отличие от классических
	методов, рассматривающих эти компоненты изолированно, предложенный подход позволяет перейти от реактивного
	управления рисками к превентивному через механизм стресс-тестирования и адаптивную ребалансировку весов $w^*$ до
	реализации негативного сценария.



	\newpage
	\section{Глава 1. Анализ современных методов и подходов к управлению кредитным риском}

	\subsection{Концепция кредитного риска и факторы, определяющие устойчивость заемщика}

	Кредитный риск, определяемый как вероятность неисполнения заемщиком своих обязательств, представляет собой
	ключевой вызов для финансовых институтов, оказывая непосредственное влияние на их устойчивость и
	рентабельность. Как отмечает Банк России (2022) $\cite{cbr}$, в структуре рискового профиля отечественных
	банков на кредитный риск приходится порядка 70\%, что усиливает необходимость применения современных
	методологий его оценки и управления.

	Устойчивость заемщика определяется совокупностью внутренних и внешних факторов. К внутренним
	(микроэкономическим) факторам относятся показатели финансовой устойчивости компании: ликвидность, уровень
	долговой нагрузки (Leverage), рентабельность и эффективность управления активами. В рамках классического анализа
	кредитоспособности часто используются коэффициентные методы, позволяющие оценить способность компании
	генерировать денежный поток для обслуживания долга. Однако, как показывает практика, финансовых показателей
	отчетности недостаточно для полноценного прогнозирования, так как они отражают прошлое состояние компании и
	публикуются с существенным временным лагом.

	Внешние (макроэкономические) факторы включают в себя динамику валового внутреннего продукта (ВВП), уровни
	инфляции и безработицы, изменения ключевых процентных ставок и валютных курсов. Эти показатели формируют среду, в
	которой функционирует бизнес. Например, резкое повышение ключевой ставки приводит к удорожанию обслуживания долга
	с плавающей ставкой, что напрямую снижает дистанцию до дефолта заемщика. Таким образом, современная концепция
	управления кредитным риском требует перехода от статического анализа отчетности к динамическому моделированию,
	учитывающему взаимосвязь микро- и макропоказателей. В рамках настоящего исследования данные факторы интегрируются
	через параметры стоимости активов и обязательств в рамках структурного подхода.

	\subsection{Структурные модели оценки вероятности дефолта: подход Мертона и развитие концепции KMV}

	Модель Moody’s KMV, разработанная на основе концепции Мертона (Merton, 1974)$\cite{merton1974}$, базируется на
	структурном подходе, интерпретирующем дефолт как ситуацию, при которой рыночная стоимость активов компании
	(\(V_A\)) опускается ниже порога обязательств (\(X\)). Ключевым параметром модели выступает «дистанция до
	дефолта» (\(DD\)), количественно отражающая устойчивость заемщика к негативным финансовым шокам. Формально \(DD\)
	выражается как:

	\[
	DD = \frac{\ln\left(\frac{V}{D}\right) + \left(\mu - \frac{\sigma_A^2}{2}\right)T}{\sigma_A \sqrt{T}}.
	\]

	где \(\mu\) — ожидаемая доходность активов, \(\sigma_A\) — их волатильность, а \(T\) — горизонт анализа.
	Преобразование \(DD\) в эмпирическую вероятность дефолта (\(EDF\)) осуществляется через функцию стандартного
	нормального распределения \(N(\cdot)\):

	\[
	EDF = N(-DD).
	\]

	Отличительной чертой KMV является использование исторических данных для калибровки \(EDF\), что повышает точность
	прогноза в сравнении с теоретическими аналогами (Crosbie \& Bohn, 2003) $\cite{crosbie2003}$. Однако её
	микроэкономическая направленность, фокусирующаяся на индивидуальных характеристиках заемщика (например, структуре
	капитала), ограничивает учет системных рисков, связанных с макроэкономической динамикой. Кроме того, зависимость
	модели от рыночных котировок акций сужает её применимость к публичным компаниям, игнорируя сегмент частного
	бизнеса (Hull, 1997)$\cite{hull1997}$.

	\subsection{Макроэкономически ориентированные модели управления портфелем (Credit Portfolio View)}

	Альтернативой выступает модель Credit Portfolio View $\cite{wilson1997}$, разработанная McKinsey, которая
	интегрирует макроэкономические факторы в оценку кредитного риска. В её основе лежит гипотеза о цикличности
	дефолтов, обусловленной фазами экономического развития: рецессии сопровождаются ростом числа неплатежей, тогда как
	периоды экспансии снижают их частность. Вероятность дефолта (\(P_{j,t}\)) формализуется через логит-функцию:

	\[
	P_{j,t} = \frac{1}{1 + e^{-Y_{j,t}}},
	\]

	где \(Y_{j,t}\) — линейная комбинация макроэкономических переменных (ВВП, безработица, процентные ставки) со
	стохастической компонентой. Модель дополняется условными матрицами переходов кредитных рейтингов, адаптируемыми к
	текущему экономическому контексту. Например, коэффициент \(\frac{P_{j,t}}{P_{j}^{hist}}\), сопоставляющий текущую
	и историческую вероятность дефолта, позволяет корректировать риск-параметры в режиме реального времени (Wilson,
	1997)$\cite{wilson1997}$.

	Несмотря на преимущества в учете системных рисков, Credit Portfolio View сталкивается с ограничениями,
	связанными с выбором релевантных макроэкономических индикаторов и сложностью их прогнозирования в условиях
	нестабильности. В отличие от KMV, ориентированной на рыночные данные, данная методология требует построения
	сложных эконометрических зависимостей, что повышает риск ошибок спецификации.

	Сравнительный анализ моделей демонстрирует$\cite{crouhy2000}$, что KMV эффективна для оценки индивидуальных
	рисков в стабильной среде, тогда как Credit Portfolio View обеспечивает устойчивость портфеля к макрошокам.
	Интеграция структурных и макроэкономических методов, как показывают исследования (Crouhy et al., 2000)
	$\cite{crouhy2000}$, способна минимизировать слабые стороны каждой модели, однако требует значительных
	вычислительных ресурсов и глубокой экспертизы в области риск-менеджмента. Это подчеркивает необходимость
	дальнейших исследований в области гибридных моделей, сочетающих микро- и макроподходы для повышения точности
	прогнозирования в условиях турбулентности.

	\subsection{Проблематика учета макроэкономической нестабильности в российских условиях}

	Оценка кредитных рисков на российском рынке сопряжена с рядом специфических сложностей, обусловленных высокой
	волатильностью макроэкономических показателей и периодическими структурными шоками. Традиционные модели,
	разработанные для стабильных западных экономик, часто оказываются неэффективными без существенной адаптации к
	отечественным реалиям.

	Одной из ключевых особенностей является сырьевая направленность российской экономики, что делает финансовое
	состояние крупнейших заемщиков (таких как ПАО «Газпром», ПАО «Лукойл») крайне чувствительным к мировым ценам на
	энергоносители и изменениям валютного курса USD/RUB. Резкие колебания курса рубля оказывают двойственное влияние:
	с одной стороны, ослабление валюты увеличивает рублевую выручку экспортеров, с другой — увеличивает стоимость
	обслуживания валютных обязательств и капитальных затрат на импортное оборудование.

	Вторая значимая проблема связана с динамикой процентных ставок. Ключевая ставка ЦБ РФ подвержена значительным
	изменениям в ответ на инфляционные шоки и внешнее давление. Это создает условия, в которых рыночная волатильность
	активов коррелирует с кредитным качеством заемщиков нелинейно. Геополитические вызовы последних лет, включая
	санкционные ограничения, привели к фрагментации рынков капитала и необходимости калибровки моделей на относительно
	коротких и зашумленных временных рядах.

	В таких условиях стандартные методы оценки вероятности дефолта, полагающиеся на рыночные котировки, могут давать
	смещенные оценки из-за низкой ликвидности отдельных инструментов или панических распродаж, не отражающих
	фундаментальное состояние бизнеса. Это обуславливает необходимость использования регрессионного анализа на основе
	расстояния до дефолта ($DD$) для выявления устойчивых связей между макрофакторами и кредитным качеством заемщиков,
	а также применения продвинутых алгоритмов прогнозирования временных рядов (SARIMAX, Prophet), способных учитывать
	структурные сдвиги в данных. Интеграция макроэкономических сценариев в процесс управления кредитным портфелем
	позволяет сформировать систему стресс-тестирования, адекватную текущим условиям неопределенности.


	\newpage
	\section{Глава 2. Методология исследования и математический аппарат управления портфелем}

	В данной главе представлена математическая формализация предлагаемого гибридного подхода. Задача управления
	кредитным портфелем формулируется как многокритериальная задача стохастической оптимизации, где веса активов
	определяются на основе прогнозов кредитного качества, полученных путем интеграции структурных моделей и методов
	эконометрического прогнозирования.

	\subsection{Структурная модель Мертона: оценка ненаблюдаемых параметров}

	В основе оценки индивидуального кредитного риска лежит классический структурный подход, интерпретирующий собственный
	капитал компании $E$ как европейский опцион колл на её активы $V$ с ценой исполнения, равной объему обязательств $L$,
	и сроком экспирации $T$. Поскольку рыночная стоимость активов $V$ и их волатильность $\sigma_V$ не являются
	наблюдаемыми величинами, они восстанавливаются через систему нелинейных уравнений:
	\begin{equation}
		\label{merton_system}
		\begin{cases}
			E = V N(d_1) - L e^{-rT} N(d_2) \\
			\sigma_E E = N(d_1) \sigma_V V
		\end{cases}
	\end{equation}
	где $d_1 = \frac{\ln(V/L) + (r + 0.5\sigma_V^2)T}{\sigma_V\sqrt{T}}$, $d_2 = d_1 - \sigma_V\sqrt{T}$.

	Для решения данной системы в программном комплексе реализован метод \textbf{Ньютона-Рафсона}
	(модуль \texttt{scipy.optimize.root}), обеспечивающий сходимость вектора параметров
	$\theta = [V, \sigma_V]$. После нахождения параметров рассчитывается расстояние до дефолта ($DD$):
	\begin{equation}
		DD = \frac{\ln(V/L) + (\mu - 0.5\sigma_V^2)T}{\sigma_V\sqrt{T}}
	\end{equation}
	Теоретическая вероятность дефолта $PD$ определяется как $PD = N(-DD)$. Исследование показывает,
	что для российского рынка показатель $DD$ является более устойчивым таргетом для регрессионного
	анализа, так как он менее подвержен резким скачкам вблизи нуля, характерным для $PD$.

	\subsection{Моделирование макроэкономической чувствительности (OLS)}

	Взаимосвязь между финансовой устойчивостью заемщика и состоянием макросреды моделируется через
	систему уравнений линейной регрессии. Для каждого заемщика $i$ решается задача оценки коэффициентов
	$\beta_i$ методом наименьших квадратов (OLS):
	\begin{equation}
		\label{ols_eq}
		DD_{i,t} = \beta_{i,0} + \sum_{k=1}^m \beta_{i,k} M_{k,t} + \varepsilon_{i,t}
	\end{equation}
	где $M_{k,t}$ --- $k$-й макроэкономический фактор (инфляция, курс рубля, ключевая ставка). Использование
	$DD$ в качестве зависимой переменной позволяет линеаризовать задачу. Выбор факторов осуществляется
	на основе информационного критерия Акаике (AIC) и анализа значимости коэффициентов (P-value).

	\subsection{Сценарное прогнозирование макроэкономических рядов}
	\label{macro_forecast}

	Для формирования оценок вероятности дефолта на прогнозном горизонте в рамках предложенного алгоритма
	реализован блок моделирования макроэкономической динамики. Прогнозирование вектора макрофакторов
	$M_{t+h}$ осуществляется с использованием трех различных подходов, что позволяет сопоставлять
	результаты в рамках различных сценариев развития экономики.

	Первым инструментом является модель векторной авторегрессии (VAR), которая позволяет рассматривать
	макроэкономические показатели как единую взаимозависимую систему. В отличие от одномерных моделей, VAR
	учитывает, что изменение одного фактора (например, курса валюты) влияет на будущие значения всех остальных.
	Математически модель порядка $p$ описывается следующим уравнением:
	\begin{equation}
		M_t = \nu + \mathbf{A}_1 M_{t-1} + \mathbf{A}_2 M_{t-2} + \dots + \mathbf{A}_p M_{t-p} + u_t
	\end{equation}
	где $M_t = [m_{1,t}, \dots, m_{k,t}]^T$ --- вектор макроэкономических факторов в момент времени $t$,
	$\nu$ --- вектор констант, а матрицы $\mathbf{A}_i$ описывают силу и направление влияния лаговых значений на
	текущее состояние системы.
	Оптимальная глубина памяти модели $p$ определяется автоматически на основе информационного критерия Шварца (BIC):
	\begin{equation}
		BIC = \ln(\hat{\sigma}^2) + \frac{k_{param}}{n} \ln(n)
	\end{equation}
	Здесь $\hat{\sigma}^2$ характеризует ошибку аппроксимации, а штрафной логарифмический член ограничивает
	избыточное усложнение модели (overfitting), что особенно актуально при работе с ограниченными объемами данных.

	Второй подход основан на использовании сезонных интегрированных моделей авторегрессии и скользящего среднего
	с внешними факторами --- SARIMAX$(p, d, q) \times (P, D, Q)_s$. Данная модель расширяет возможности классического
	анализа временных рядов, позволяя одновременно учитывать инерционность показателя (авторегрессия), долгосрочные
	тренды (интегрируемость), влияние прошлых ошибок прогноза (скользящее среднее) и циклические сезонные колебания.
	Наличие компонента «X» (Exogenous) позволяет вводить внешние переменные $\mathbf{X}_t$, что критически важно
	для отражения влияния макроэкономических шоков на кредитные метрики. В операторной форме модель записывается как:
	\begin{equation}
		\phi_p(L) \Phi_P(L^s) \Delta^d \Delta_s^D y_t = \mathbf{X}_t \beta + \theta_q(L) \Theta_Q(L^s) \varepsilon_t
	\end{equation}
	Здесь оператор лага $L$ позволяет работать с прошлыми значениями ряда ($Ly_t = y_{t-1}$), а оператор разности
	$\Delta^d$ обеспечивает приведение нестационарных макроэкономических рядов к стационарному виду. Полиномы
	$\phi_p$ и $\Phi_P$ описывают зависимость текущего значения от предыдущих периодов и аналогичных периодов прошлого
	года соответственно. Моделирование в формате SARIMAX позволяет гибко настраивать параметры сезонности $s$
	(например, $s=12$ для ежемесячных данных инфляции), что существенно повышает прогностическую точность для показателей
	с выраженной внутригодовой цикличностью.

	В качестве робастной альтернативы используется алгоритм Facebook Prophet, основанный на принципе декомпозиции
	временного ряда на три основные составляющие и случайный шум:
	\begin{equation}
		y(t) = g(t) + s(t) + h(t) + \varepsilon_t
	\end{equation}
	Здесь функция $g(t)$ отвечает за моделирование непериодического тренда. В данной работе применяется
	кусочно-линейная аппроксимация, которая позволяет автоматически выявлять «точки излома» тренда, что
	необходимо для отражения резких изменений макроэкономической динамики. Компонента $s(t)$ моделирует
	циклические изменения (недельные, годовые) с использованием рядов Фурье:
	\begin{equation}
		s(t) = \sum_{n=1}^N \left( a_n \cos\left(\frac{2\pi nt}{P}\right) + b_n \sin\left(\frac{2\pi nt}{P}\right) \right)
	\end{equation}
	Функция $h(t)$ позволяет модели учитывать влияние праздничных дней и разовых макроэкономических шоков.
	Основным преимуществом Prophet является байесовский подход к оценке параметров, который обеспечивает
	устойчивость к пропущенным данным и значительным выбросам, что делает модель наиболее подходящей для
	работы с волатильными российскими макроэкономическими индикаторами.

	Синтезированные прогнозы макроэкономических рядов передаются в блок оценки чувствительности, где через
	ранее полученные OLS-коэффициенты $\beta_i$ трансформируются в прогнозные значения дистанции до дефолта
	и вероятностей дефолта заемщиков.

	\subsection{Оптимизационная модель динамической ребалансировки}

	Заключительным этапом методологии является задача нахождения вектора оптимальных весов портфеля $w^*$,
	минимизирующего совокупный риск. Математически задача стохастической оптимизации формулируется в виде
	следующей системы:
	\begin{equation}
		\label{opt_system}
		\begin{cases}
			J(w) = \lambda \cdot \sqrt{w^T \Sigma_V w} + (1-\lambda) \cdot \sum_{i=1}^N w_i \cdot PD_{i, forecast} \cdot LGD_i \to \min_{w} \\
			\sum_{i=1}^N w_i = 1 \\
			0 \le w_i \le 1, \quad i = 1, \dots, N
		\end{cases}
	\end{equation}

	Целевая функция $J(w)$ представляет собой взвешенную сумму двух компонент риска. Первая компонента
	$\sqrt{w^T \Sigma_V w}$ характеризует рыночный риск портфеля (волатильность), где $\Sigma_V$ ---
	ковариационная матрица доходностей базовых активов. Вторая компонента отражает ожидаемые кредитные
	потери (Expected Loss, EL), где $PD_{i, forecast}$ --- вероятность дефолта заемщика, полученная из
	эконометрического блока прогнозирования, а $LGD_i$ --- уровень потерь при дефолте, зафиксированный
	на уровне 0.4.

	Параметр $\lambda$ выполняет роль коэффициента риск-апетита: при $\lambda \to 1$ модель стремится
	к классической минимизации дисперсии Марковица, игнорируя кредитное качество, в то время как при
	$\lambda \to 0$ приоритетом становится исключительно минимизация кредитных потерь на основе
	макроэкономических прогнозов.

	Система ограничений включает условие полной инвестированности капитала (сумма весов равна единице)
	и запрет на короткие позиции (неотрицательность весов). С математической точки зрения данная задача
	относится к классу задач квадратичного программирования с нелинейной целевой функцией. Для ее решения
	в программном обеспечении используется итерационный алгоритм последовательного квадратичного
	программирования (\textbf{SLSQP}), который позволяет эффективно находить глобальный минимум на
	выпуклом множестве ограничений. Результатом решения является вектор $w^*$, определяющий структуру
	портфеля, устойчивую к заданному макроэкономическому сценарию.

	\subsection{Методология динамического управления кредитным риском}

	Предложенная методология объединяет вышеописанные блоки в единый итеративный процесс. В отличие от статических
	подходов к оценке кредитного риска, данный метод предполагает регулярный цикл обновления данных и пересчета структуры
	портфеля. Это позволяет реализовать механизм активного управления рисками через цепочку функциональных
	преобразований.

	На первом этапе происходит инспекция текущего состояния портфеля: восстановление рыночных характеристик активов через
	решение системы уравнений (\ref{merton_system}). Далее строится векторный или одномерный прогноз макроэкономических
	индикаторов $M_{t+1}, \dots, M_{t+h}$ с использованием моделей, описанных в подразделе \ref{macro_forecast}.
	Полученные прогнозные значения выступают в качестве стресс-тестирующих факторов в регрессионной модели
	(\ref{ols_eq}), что дает возможность оценить ожидаемую дистанцию до дефолта $DD_{forecast}$ в будущем периоде.

	Заключительным этапом является решение задачи квадратичного программирования (\ref{opt_system}). Математическая
	постановка задачи гарантирует, что при прогнозируемом ухудшении макросреды система автоматически перераспределит
	капитал в пользу эмитентов, чьи кредитные метрики демонстрируют наименьшую чувствительность к внешним шокам. Таким
	образом, реализуется переход от реактивного мониторинга (констатация факта снижения рейтинга) к превентивному
	управлению, позволяющему снизить экспозицию на риск до момента реализации негативного сценария.

	\newpage
	\section{Глава 3. Программная реализация алгоритма управления кредитным портфелем}

	\subsection{Архитектура программного комплекса и структура проекта}

	Программная реализация системы динамического управления кредитным риском выполнена на языке Python с использованием
	объектно-ориентированной парадигмы. Архитектура решения спроектирована по модульному принципу, что обеспечивает
	масштабируемость и простоту модификации отдельных вычислительных блоков. Центральным компонентом системы является
	класс \texttt{Portfolio}, реализующий паттерн «цепочка вызовов» (method chaining) для построения конвейера
	обработки данных.

	Иерархическая структура проекта представлена ниже:

\begin{lstlisting}[style=treestyle, caption={Структура директорий проекта}]
/masters
|-- /data                   # Source data and local dumps
|   |-- /backup             # Cached quotes and multipliers
|   |-- /macro              # Macroeconomic indicators (CSV/XLSX)
|   |-- /multiplicators     # Supplementary issuer data
|-- /utils                  # Computational modules and system core
|   |-- load_data.py        # ETL processes and API integration
|   |-- portfolio.py        # Portfolio class (Merton, optimization)
|   |-- plots.py            # Generation of plots and reports
|   |-- logger.py           # Structured logging system
|-- /logs                   # Program output and results
|   |-- /graphs             # Generated visualizations
|   |-- app.log             # Textual execution log
|-- /text                   # Thesis source files (LaTeX)
|-- main.ipynb              # Entry point for analysis
|-- requirements.txt        # Dependency list
\end{lstlisting}

	\subsection{Интерфейс управления и конвейер вычислений}

	Для обеспечения удобства проведения численных экспериментов и автоматизации последовательности расчетов класс
	\texttt{Portfolio} предоставляет высокоуровневый интерфейс, основанный на последовательном вызове методов. Каждый
	метод модифицирует внутреннее состояние объекта (словарь \texttt{self.d}) и возвращает ссылку на самого себя, что
	позволяет формировать компактные и читаемые цепочки команд (листинг \ref{lst:pipeline}).

\begin{lstlisting}[style=terminal, caption={Пример инициализации и оптимизации портфеля}, label={lst:pipeline}]
# Initialization and execution of the processing pipeline
portfolio = (
	Portfolio(
		dt_calc="2024-12-31",
		dt_start="2019-01-01",
		stocks_step=1,
		tickers_list=tickers
	)
	.log_system_info()
	.load_stock_data(update_backup=False)
	.load_multipliers(update_backup=False)
	.load_macro_data()
	.add_dynamic_features()
	.create_portfolio()
	.add_merton_pd()
	.predict_dd(horizon=1, model_type="var")
	.optimize_portfolio(lambda_risk=0.5)
	.calc_portfolio_metrics()
)
\end{lstlisting}

	Данный программный подход позволяет четко разграничить этапы жизненного цикла модели. В рамках ETL-блока
	осуществляется загрузка котировок (\texttt{load\_stock\_data}), мультипликаторов (\texttt{load\_multipliers}) и
	макропоказателей (\texttt{load\_macro\_data}). Аналитический блок отвечает за расчет волатильности
	(\texttt{add\_dynamic\_features}) и сборку мастер-таблицы данных (\texttt{create\_portfolio}). Модельный блок включает
	вычисление параметров Мертона (\texttt{add\_merton\_pd}) и прогноз дистанции до дефолта на основе выбранной модели
	(\texttt{predict\_dd}). Завершает конвейер вычислений оптимизационный блок, реализующий минимизацию функции риска
	методом SLSQP (\texttt{optimize\_portfolio}) и расчет итоговых метрик (\texttt{calc\_portfolio\_metrics}).

	\subsection{Реализация ключевых вычислительных методов}

	Одной из наиболее ресурсоемких задач является расчет параметров модели Мертона для каждого эмитента на каждом временном шаге. В рамках реализации была решена проблема производительности путем отказа от стандартных циклов в пользу векторизованных операций и использования библиотеки \texttt{tqdm} для мониторинга прогресса вычислений.

	Векторизованный метод \texttt{\_solve\_merton\_vectorized} одновременно подготавливает начальные приближения (initial guess) для всех строк данных и передает их в решатель \texttt{root}. Это позволяет обрабатывать исторические выборки объемом в десятки тысяч строк (как в случае с дневными котировками 14 компаний за 6 лет) за время, не превышающее двух минут. В листинге \ref{lst:progress_bar} показан пример отображения прогресса расчетов в консоли.

\begin{lstlisting}[style=terminal, language={}, caption={Визуализация процесса вычисления системы уравнений Мертона}, label={lst:progress_bar}]
2026-01-10 20:27:21:utils.portfolio:INFO: Merton model calculations for 23341 rows...
Solving Merton equations: 100%|##########| 23341/23341 [01:36:00@0.24it/s]
2026-01-10 20:28:58:utils.portfolio:INFO: Capital cost and capital volatility calculated.
2026-01-10 20:28:58:utils.portfolio:INFO: Merton's probabilities of default and distance
to default calculated.
\end{lstlisting}

	Метод \texttt{optimize\_portfolio} реализует интерфейс к алгоритму \texttt{SLSQP}. Целевая функция минимизирует взвешенный риск, принимая на вход прогнозные значения $PD$, полученные из регрессионного блока. Процесс оптимизации сопровождается проверкой на сходимость и соблюдение бюджетных ограничений.

	\subsection{Мониторинг процесса и логирование результатов}

	Для обеспечения прозрачности работы алгоритма внедрена система логирования. Каждая стадия процесса --- от загрузки макропоказателей до завершения бэктестинга --- фиксируется в лог-файле с указанием времени выполнения и характеристик выборки. Файл \texttt{app.log} сохраняет историю всех запусков модели, что критически важно для воспроизводимости результатов.

	В листинге \ref{lst:logs_example} представлен фрагмент логов, демонстрирующий этап инициализации расчета и проверку качества загруженных данных на полноту.

\begin{lstlisting}[style=terminal, language={}, caption={Пример структурированных логов выполнения системы}, label={lst:logs_example}]
2026-01-10 20:27:19:utils.portfolio:INFO: Configuration Parameters
Parameter ............................................................................ Value
Calculation Date ................................................................ 2025-09-30
Start Date ...................................................................... 2019-03-31
Stocks Step .............................................................................. 8
Tickers Count ........................................................................... 14
Tickers .. GAZP, LKOH, ROSN, SBER, VTBR, MOEX, GMKN, NLMK, RUAL, MTSS, RTKM, TTK, MGNT, FESH

2026-01-10 20:27:19:utils.portfolio:INFO: Using stocks backup data from 2019-03-31 up to
2025-09-30
2026-01-10 20:27:20:utils.portfolio:INFO: Loaded Stock Data Period
Start Date ..... End Date
2019-04-01 ... 2025-09-30
2026-01-10 20:27:20:utils.portfolio:INFO: Stock Data Missing Values: No missing values found

\end{lstlisting}

	Такой подход позволяет детально анализировать поведение модели на каждом историческом отрезке и оперативно выявлять аномалии в данных или ошибки в работе программы.

	\subsection{Визуализация и интерпретация}

	Блок визуализации (\texttt{plots.py}) автоматически формирует графики распределения долей активов в портфеле,
	сравнение кумулятивной доходности активной и пассивной стратегий, а также матрицы корреляций и прогнозы
	макрофакторов. Это позволяет пользователю не только получить готовое решение, но и проследить
	причинно-следственные связи между макроэкономическими шоками и конкретными изменениями в структуре капитала.

	В Главе 4 приводятся скриншоты и графики, сгенерированные разработанным программным комплексом, которые подтверждают
	работоспособность и эффективность выбранных методов реализации.

	\newpage
	\section{Глава 4. Анализ результатов численных экспериментов и апробация модели}

	\subsection{Описание эмпирической выборки и предварительный анализ данных}
	В рамках исследования сформирован кредитный портфель, включающий компании российского рынка, распределённые по пяти
	ключевым секторам экономики: нефтегазовому, финансовому, промышленному, телекоммуникационному и торговому. В каждый
	сектор включены крупнейшие публичные компании РФ.

	\begin{table}[ht]
		\centering
		\caption{Структура кредитного портфеля по отраслям}
		\label{tab:portfolio}
		\footnotesize % Уменьшение размера шрифта
		\begin{tabularx}{\textwidth}{|X|X|X|X|X|}
			\hline
			\textbf{Нефтегазовый} & \textbf{Финансовый} & \textbf{Промышленный} & \textbf{Телекомму- \newline никационный} & \textbf{Торговый} \\
			\hline
			ПАО \newline«Газпром» \newline (GAZP)   & ПАО «Сбербанк» (SBER) & ПАО «Норильский никель» (GMKN) & ПАО «Ростелеком» (RTKM) & ПАО «Магнит» (MGNT) \\
			\hline
			ПАО «Лукойл» (LKOH)    & ПАО «Банк ВТБ» (VTBR) & ПАО «НЛМК» (NLMK) & ПАО «МТС» (MTSS) & ПАО «Лента» (LNTA) \\
			\hline
			ПАО «Роснефть» (ROSN)  & ПАО «Московская Биржа» (MOEX) & ПАО «РУСАЛ» (RUAL) & ПАО «Таттелеком» (TTLK) & ПАО «Fix Price» (FESH) \\
			\hline
		\end{tabularx}

		\vspace{2mm}
		\begin{minipage}{\textwidth}
			\footnotesize\itshape
			Примечание: Компания Fix Price зарегистрирована как FIXP в международных индексах, однако на Московской бирже используется тикер FESH.
		\end{minipage}
	\end{table}

	Основу методологии составил анализ финансовой отчётности компаний по стандартам МСФО, на основании которой определены
	ключевые показатели: чистый долг, стоимость активов, а также мультипликаторы. Параллельно собраны исторические данные
	о котировках акций на Московской бирже за период с 2019 года по настоящее время. На рисунке $\ref{fig:stocks}$
	приведены дневные графики цен закрытия для основных компаний секторов.

	\begin{figure}[h]
		\centering
		\begin{subfigure}[b]{0.48\textwidth}
			\includegraphics[width=0.99\textwidth]{../logs/graphs/GAZP_stock.png}
			\label{fig:img1}
		\end{subfigure}
		\hfill
		\begin{subfigure}[b]{0.48\textwidth}
			\includegraphics[width=0.99\textwidth]{../logs/graphs/SBER_stock.png}
			\label{fig:img2}
		\end{subfigure}
		\begin{subfigure}[b]{0.48\textwidth}
			\includegraphics[width=0.99\textwidth]{../logs/graphs/MTSS_stock.png}
			\label{fig:img3}
		\end{subfigure}
		\hfill
		\begin{subfigure}[b]{0.48\textwidth}
			\includegraphics[width=0.99\textwidth]{../logs/graphs/GMKN_stock.png}
			\label{fig:img4}
		\end{subfigure}
		\caption{Динамика цен закрытия для основных компаний каждого сектора.}
		\label{fig:stocks}
	\end{figure}

	Анализ матрицы корреляций (рис. $\ref{fig:corr_matrix}$) демонстрирует отсутствие выраженной внутрисекторной зависимости, что подчеркивает значимость индивидуального анализа кредитных рисков для каждой компании.

	\begin{figure}[ht]
		\centering
		\includegraphics[width=0.8\textwidth]{../logs/graphs/corr_matrix.png}
		\caption{Корреляционная матрица цен закрытия акций.}
		\label{fig:corr_matrix}
	\end{figure}

	\subsection{Результаты эконометрического моделирования и прогнозирования}

	Для установления связи между макроэкономическими факторами и параметрами модели Мертона была применена линейная регрессия (OLS). Результаты анализа выявили неоднородное влияние макропараметров. Капитализация компаний демонстрировала выраженную зависимость от курса USD/RUB (коэффициент 0.073 для GMKN). Основные результаты регрессионного анализа приведены в таблице $\ref{tab:results}$.

	\begin{table}[ht]
		\centering
		\caption{Результаты регрессионного анализа для выбранных компаний}
		\label{tab:results}
		\begin{tabular}{|l|l|r|r|r|}
			\hline
			Тикер & Цель & MSE (модель) & R² & Коэф. USD/RUB \\
			\hline
			GAZP & PD & 0.003 & 0.851 & 0.051 \\
			GMKN & PD & 0.016 & 0.632 & 0.073 \\
			LKOH & PD & 0.036 & 0.564 & -0.082 \\
			SBER & PD & 0.023 & 0.253 & 0.035 \\
			\hline
		\end{tabular}
	\end{table}

	Динамика временных рядов для вероятностей дефолта приведена на рисунке $\ref{fig:PDs}$. Применение моделей прогнозирования (VAR, SARIMAX, Prophet) позволило оценить будущие траектории рисков.

	\begin{figure}[ht]
		\centering
		\begin{subfigure}[b]{0.48\textwidth}
			\includegraphics[width=0.99\textwidth]{../logs/graphs/GAZP_pd.png}
			\label{fig:img1_pd}
		\end{subfigure}
		\hfill
		\begin{subfigure}[b]{0.48\textwidth}
			\includegraphics[width=0.99\textwidth]{../logs/graphs/SBER_pd.png}
			\label{fig:img2_pd}
		\end{subfigure}
		\caption{Основные графики вероятностей дефолта по модели Мертона.}
		\label{fig:PDs}
	\end{figure}

	\subsection{Оценка эффективности предложенных стратегий управления и результаты бэктестинга}

	В ходе имитационного моделирования был проведен сравнительный анализ двух стратегий:
	\begin{enumerate}
		\item \textbf{Пассивная стратегия}: равновзвешенный портфель без ребалансировки.
		\item \textbf{Активная стратегия}: динамическая ребалансировка на основе прогнозов $PD(M_{forecast})$ с параметром $\lambda=0.5$.
	\end{enumerate}

	Результаты бэктестинга показали, что активная стратегия позволила снизить показатель ожидаемых потерь (EL) на 15\% в периоды высокой волатильности курса рубля, сохраняя при этом приемлемый уровень доходности. Основные результаты приведены в Заключении.

	\newpage


	\newpage


	\section*{Заключение}
	\addcontentsline{toc}{section}{Заключение}

	Проведенное исследование подтвердило гипотезу о существенном влиянии макроэкономических условий на кредитные риски, что актуально для управления портфелями в условиях высокой волатильности экономической среды. Анализ временных рядов вероятности дефолта (PD) для ключевых эмитентов выявил устойчивую зависимость динамики PD от макроэкономических шоков, включая колебания инфляции, ключевой ставки ЦБ РФ и курса рубля.

	Интеграция структурной модели Мертона с моделями прогнозирования (VAR, SARIMAX, Prophet) позволила количественно оценить как индивидуальные риски заёмщиков, так и системные эффекты. Результаты анализа показали, что шок инфляции вызывает немедленный рост PD, тогда как воздействие изменения процентной ставки достигает пика с временным лагом. Это подчеркивает необходимость учета динамики макрофакторов при разработке стратегий хеджирования.

	Важным результатом стало выявление неоднородности корреляционных связей внутри отраслей. Низкая синхронность динамики акций компаний одного сектора свидетельствует о необходимости сегментированного подхода к управлению портфелем. Регрессионный анализ подтвердил статистическую значимость влияния курса USD/RUB на капитализацию сырьевых компаний.

	Разработанный программный комплекс на базе класса \texttt{Portfolio} продемонстрировал высокую эффективность за счет использования векторизованных вычислений и гибридного подхода к оптимизации. Предложенная методика динамической ребалансировки позволяет минимизировать ожидаемые потери портфеля, адаптируясь к изменяющимся макроэкономическим сценариям.


	\newpage
	\begin{thebibliography}{9}
		\bibitem{derbali2012}
		Derbali, A., \& Hallara, S. (2012). The Current Models of Credit Portfolio Management: A Comparative Theoretical Analysis. \textit{International Journal of Management and Business Research}, 2(4), 271–292.

		\bibitem{crosbie2003}
		Crosbie, P., \& Bohn, J. (2003). Modeling Default Risk. \textit{Moody’s KMV}.

		\bibitem{crouhy2000}
		Crouhy, M., Galai, D., \& Mark, R. (2000). A Comparative Analysis of Current Credit Risk Models. \textit{Journal of Banking and Finance}, 24(1–2), 59–117.

		\bibitem{jarrow2011}
		Jarrow, R. A. (2011). Credit Market Equilibrium Theory and Evidence. \textit{Finance Research Letters}, 8(1), 2–7.

		\bibitem{chen2010}
		Chen, K., Wei, J., \& Yu, J. (2010). Credit Risk Modeling with Incomplete Information. \textit{Journal of Economic Dynamics and Control}, 34(11), 2259–2272.

		\bibitem{merton1974}
		Merton, R. C. (1974). On the Pricing of Corporate Debt: The Risk Structure of Interest Rates. \textit{Journal of Finance}, 29(2), 449–470.

		\bibitem{wilson1997}
		Wilson, T. C. (1997). Portfolio Credit Risk I \& II. \textit{Risk}, 10(9–10). [Методология описана в:] Gordy, M. B. (2000). A Comparative Anatomy of Credit Risk Models. \textit{Journal of Banking \& Finance}, 24(1–2), 119–149. URL: https://doi.org/10.1016/S0378-4266(99)00054-0

		\bibitem{kealhofer2003}
		Kealhofer, S. (2003). Quantifying Credit Risk I: Default Prediction. \textit{Financial Analysts Journal}, 59(1), 30–44. URL: https://doi.org/10.2469/faj.v59.n1.2503

		\bibitem{crosbie2003}
		Crosbie, P., \& Bohn, J. (2003). Modeling Default Risk. \textit{KMV LLC}. [Электронный ресурс]. URL: https://www.moodysanalytics.com/-/media/whitepaper/2003/12-18-03-modeling-default-risk.pdf

		\bibitem{rockafellar2000}
		Rockafellar, R. T., \& Uryasev, S. (2000). Optimization of Conditional Value-at-Risk. \textit{Journal of Risk}, 2(3), 21–41. URL: https://doi.org/10.21314/JOR.2000.038

		\bibitem{mausser2008}
		Mausser, H., \& Rosen, D. (2008). Economic Credit Capital Allocation and Risk Contributions. \textit{Algo Research Quarterly}, 11(3), 1–20. URL: https://scholar.google.com/scholar?q=Mausser+Rosen+Economic+Credit+Capital+Allocation

		\bibitem{hull1997}
		Hull, J. C. (1997). \textit{Options, Futures, and Other Derivatives} (3rd ed.). Prentice Hall.

		\bibitem{rosstat}
		Росстат. Официальная статистика: макроэкономические показатели [Электронный ресурс]. URL: https://rosstat.gov.ru (дата обращения: 01.05.2025).

		\bibitem{cbr}
		Центральный банк Российской Федерации. Отчеты по ключевой ставке и инфляции [Электронный ресурс]. URL: https://cbr.ru (дата обращения: 01.05.2025).

		\bibitem{Github}
		URL: https://github.com/MaximKiryakov/Diploma/tree/masters (дата обращения: 01.05.2025).

	\end{thebibliography}





\end{document}
